{% comment %}
  这是一个完整的 Section 文件，包含了所有必需的部分：
  1. HTML 结构 (定制器的界面)
  2. CSS 样式 (让界面看起来更美观)
  3. JavaScript 脚本 (驱动功能的逻辑，使用最稳健的轮询方法)
  4. Liquid Schema (让 Shopify 识别这是一个 Section)
{% endcomment %}

<div class="page-width">
  <div class="customizer-container">
    
    <div class="customizer-controls">
      <h3>设计你的标签</h3>
      
      <div class="control-group">
        <label for="text-input">输入文字:</label>
        <input type="text" id="text-input" placeholder="你的文字">
      </div>

      <div class="control-group">
        <label for="font-size-input">字体大小:</label>
        <input type="number" id="font-size-input" value="20" min="8" max="72">
      </div>

      <div class="control-group">
        <label for="color-input">字体颜色:</label>
        <input type="color" id="color-input" value="#000000">
      </div>

      <button id="add-to-cart-btn" class="button button--primary">添加到购物车</button>
    </div>

    <div class="canvas-wrapper">
      {% comment %} 这是我们一直在寻找的目标元素！ {% endcomment %}
      <div id="konva-container"></div>
    </div>

  </div>
</div>

<style>
  .customizer-container {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    margin: 40px 0;
    padding-top: 40px;
    border-top: 1px solid #e5e5e5;
  }
  .customizer-controls {
    flex: 1;
    min-width: 250px;
  }
  .canvas-wrapper {
    flex: 2;
    min-width: 400px;
    background-color: #f7f7f7;
    border: 1px solid #ccc;
    height: 200px;
  }
  #konva-container {
    width: 100%;
    height: 100%;
  }
  .control-group {
    margin-bottom: 20px;
  }
  .control-group label {
    display: block;
    margin-bottom: 5px;
  }
  .control-group input {
    width: 100%;
    padding: 8px;
  }
</style>

{% comment %} <script>
  const initializeKonvaApp = (sectionElement) => {
    const konvaContainer = sectionElement.querySelector('#konva-container');
    if (!konvaContainer || konvaContainer.dataset.initialized === 'true') return;
    konvaContainer.dataset.initialized = 'true';

    console.log("Konva Log: 目标元素已找到，开始初始化...");

    const stageWidth = konvaContainer.clientWidth;
    const stageHeight = konvaContainer.clientHeight;
    const stage = new Konva.Stage({ container: konvaContainer, width: stageWidth, height: stageHeight });
    const layer = new Konva.Layer();
    stage.add(layer);
    const backgroundRect = new Konva.Rect({ x: 0, y: 0, width: stageWidth, height: stageHeight, fill: '#FFFFFF', stroke: '#dddddd', strokeWidth: 1 });
    layer.add(backgroundRect);
    const konvaText = new Konva.Text({ x: stageWidth / 2, y: stageHeight / 2, text: '你的文字', fontSize: 20, fontFamily: 'Arial', fill: '#000000', draggable: true });
    layer.add(konvaText);
    konvaText.offsetX(konvaText.width() / 2);
    konvaText.offsetY(konvaText.height() / 2);
    layer.draw();

    const textInput = sectionElement.querySelector('#text-input');
    const fontSizeInput = sectionElement.querySelector('#font-size-input');
    const colorInput = sectionElement.querySelector('#color-input');
    const addToCartBtn = sectionElement.querySelector('#add-to-cart-btn');

    textInput.addEventListener('input', (e) => { konvaText.text(e.target.value || ' '); konvaText.offsetX(konvaText.width() / 2); layer.draw(); });
    fontSizeInput.addEventListener('input', (e) => { konvaText.fontSize(parseInt(e.target.value, 10)); konvaText.offsetX(konvaText.width() / 2); konvaText.offsetY(konvaText.height() / 2); layer.draw(); });
    colorInput.addEventListener('input', (e) => { konvaText.fill(e.target.value); layer.draw(); });
    addToCartBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const productForm = document.querySelector('form[action*="/cart/add"]');
      const variantIdInput = productForm ? productForm.querySelector('[name="id"]') : null;
      if (!variantIdInput || !variantIdInput.value) { alert('错误：找不到产品变体ID。'); return; }
      const variantId = variantIdInput.value;
      backgroundRect.hide();
      layer.draw();
      const previewImage = stage.toDataURL({ pixelRatio: 2 });
      backgroundRect.show();
      layer.draw();
      const formData = { items: [{ id: variantId, quantity: 1, properties: { '_CustomTextPreview': previewImage, '定制文字': textInput.value, '字体大小': fontSizeInput.value, '字体颜色': colorInput.value }}] };
      fetch('/cart/add.js', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) })
        .then(res => res.json()).then(data => { if (!data.status) { window.location.href = '/cart'; } else { alert('添加失败: ' + data.description); }})
        .catch(console.error);
    });

    console.log("Konva Log: 定制器已成功初始化并准备就绪！");
  };

  const bootstrapper = () => {
    const sectionId = 'shopify-section-{{ section.id }}';
    const sectionElement = document.getElementById(sectionId);
    if (!sectionElement) return;

    const intervalId = setInterval(() => {
      const konvaContainer = sectionElement.querySelector('#konva-container');
      if (konvaContainer) {
        clearInterval(intervalId);
        initializeKonvaApp(sectionElement);
      }
    }, 100);
    setTimeout(() => { clearInterval(intervalId); }, 5000);
  };

  document.addEventListener('turbo:load', bootstrapper);
  document.addEventListener('shopify:section:load', bootstrapper);
  bootstrapper();
</script> {% endcomment %}

<script>
  // 将我们的核心初始化逻辑封装在一个独立的函数中
  const initializeKonvaApp = (sectionElement) => {
    const konvaContainer = sectionElement.querySelector('#konva-container');
    if (!konvaContainer || konvaContainer.dataset.initialized === 'true') return;
    konvaContainer.dataset.initialized = 'true';

    console.log("--- Konva 调试开始 ---");
    console.log("1. 目标元素已找到，准备初始化...");

    // ---- Konva 核心代码 ----
    const stageWidth = konvaContainer.clientWidth;
    const stageHeight = konvaContainer.clientHeight;
    console.log(`2. 画布尺寸: ${stageWidth}w x ${stageHeight}h`);

    const stage = new Konva.Stage({ container: konvaContainer, width: stageWidth, height: stageHeight });
    const layer = new Konva.Layer();
    stage.add(layer);

    // 【调试1：暂时移除背景】为了确保背景没有覆盖文字，我们先不添加它
    // const backgroundRect = new Konva.Rect({ ... });
    // layer.add(backgroundRect);

    const konvaText = new Konva.Text({
      x: stageWidth / 2,
      y: stageHeight / 2,
      text: '你的文字',
      fontSize: 30, // 【调试2：使用更大的字号】
      fontFamily: 'Arial',
      fill: 'red', // 【调试3：使用鲜艳的颜色】
      draggable: true
    });
    layer.add(konvaText);
    
    // 重新计算偏移量
    konvaText.offsetX(konvaText.width() / 2);
    konvaText.offsetY(konvaText.height() / 2);
    
    console.log(`3. 文字对象创建: text='${konvaText.text()}', fontSize=${konvaText.fontSize()}`);
    console.log(`4. 文字尺寸: ${konvaText.width()}w x ${konvaText.height()}h`);
    console.log(`5. 文字坐标: x=${konvaText.x()}, y=${konvaText.y()}`);
    console.log(`6. 文字偏移: offsetX=${konvaText.offsetX()}, offsetY=${konvaText.offsetY()}`);

    // 【最终解决方案：强制延迟绘制】
    // 这会把绘制命令推到浏览器任务队列的末尾，确保所有准备工作都已完成。
    setTimeout(() => {
      layer.draw();
      console.log("7. 已执行延迟绘制！现在应该能看到文字了。");
    }, 100); // 延迟100毫秒，非常可靠

    // ---- 事件监听器 (保持不变) ----
    const textInput = sectionElement.querySelector('#text-input');
    const fontSizeInput = sectionElement.querySelector('#font-size-input');
    const colorInput = sectionElement.querySelector('#color-input');
    const addToCartBtn = sectionElement.querySelector('#add-to-cart-btn');

    // 我们需要重新把背景加回来，以便在“添加到购物车”时可以隐藏它
    const backgroundRect = new Konva.Rect({ x: 0, y: 0, width: stageWidth, height: stageHeight, fill: '#FFFFFF', stroke: '#dddddd', strokeWidth: 1 });
    layer.add(backgroundRect);
    backgroundRect.moveToBottom(); // 确保背景在最底层

    // ... 事件监听器代码保持原样 ...
    textInput.addEventListener('input', (e) => { konvaText.text(e.target.value || ' '); konvaText.offsetX(konvaText.width() / 2); layer.draw(); });
    fontSizeInput.addEventListener('input', (e) => { konvaText.fontSize(parseInt(e.target.value, 10)); konvaText.offsetX(konvaText.width() / 2); konvaText.offsetY(konvaText.height() / 2); layer.draw(); });
    colorInput.addEventListener('input', (e) => { konvaText.fill(e.target.value); layer.draw(); });
    addToCartBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const productForm = document.querySelector('form[action*="/cart/add"]');
      const variantIdInput = productForm ? productForm.querySelector('[name="id"]') : null;
      if (!variantIdInput || !variantIdInput.value) { alert('错误：找不到产品变体ID。'); return; }
      const variantId = variantIdInput.value;
      backgroundRect.hide();
      layer.draw();
      const previewImage = stage.toDataURL({ pixelRatio: 2 });
      backgroundRect.show();
      layer.draw();
      const formData = { items: [{ id: variantId, quantity: 1, properties: { '_CustomTextPreview': previewImage, '定制文字': textInput.value, '字体大小': fontSizeInput.value, '字体颜色': colorInput.value }}] };
      fetch('/cart/add.js', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) })
        .then(res => res.json()).then(data => { if (!data.status) { window.location.href = '/cart'; } else { alert('添加失败: ' + data.description); }})
        .catch(console.error);
    });
  };

  // ---- 轮询启动器 (保持不变) ----
  const bootstrapper = () => {
    const sectionId = 'shopify-section-{{ section.id }}';
    const sectionElement = document.getElementById(sectionId);
    if (!sectionElement) return;

    const intervalId = setInterval(() => {
      const konvaContainer = sectionElement.querySelector('#konva-container');
      if (konvaContainer) {
        clearInterval(intervalId);
        initializeKonvaApp(sectionElement);
      }
    }, 100);
    setTimeout(() => { clearInterval(intervalId); }, 5000);
  };

  document.addEventListener('turbo:load', bootstrapper);
  document.addEventListener('shopify:section:load', bootstrapper);
  bootstrapper();
</script>

{% schema %}
{
  "name": "Product Text Customizer",
  "settings": [],
  "presets": [
    {
      "name": "Product Text Customizer"
    }
  ]
}
{% endschema %}