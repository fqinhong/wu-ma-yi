{% comment %}
  我们将 HTML, CSS 和 JavaScript 全部写在这个文件中，方便管理。
{% endcomment %}

<div class="page-width">
  <div class="customizer-container">
    
    <div class="customizer-controls">
      <h3>设计你的标签</h3>
      
      <div class="control-group">
        <label for="text-input">输入文字:</label>
        <input type="text" id="text-input" placeholder="你的文字">
      </div>

      <div class="control-group">
        <label for="font-size-input">字体大小:</label>
        <input type="number" id="font-size-input" value="20" min="8" max="72">
      </div>

      <div class="control-group">
        <label for="color-input">字体颜色:</label>
        <input type="color" id="color-input" value="#000000">
      </div>

      <button id="add-to-cart-btn" class="button button--primary">添加到购物车</button>
    </div>

    <div class="canvas-wrapper">
      <div id="konva-container"></div>
    </div>

  </div>
</div>

<style>
  .customizer-container {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    margin: 40px 0;
    padding-top: 40px;
    border-top: 1px solid #e5e5e5;
  }
  .customizer-controls {
    flex: 1;
    min-width: 250px;
  }
  .canvas-wrapper {
    flex: 2;
    min-width: 400px;
    background-color: #f7f7f7;
    border: 1px solid #ccc;
    height: 200px; /* 画布容器高度 */
  }
  #konva-container {
    width: 100%;
    height: 100%;
  }
  .control-group {
    margin-bottom: 20px;
  }
  .control-group label {
    display: block;
    margin-bottom: 5px;
  }
  .control-group input {
    width: 100%;
    padding: 8px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- 1. 初始化 Konva 画布 ---
    const container = document.querySelector('#konva-container');
    const stageWidth = container.clientWidth;
    const stageHeight = container.clientHeight;

    const stage = new Konva.Stage({
      container: 'konva-container',
      width: stageWidth,
      height: stageHeight,
    });

    const layer = new Konva.Layer();
    stage.add(layer);

    // --- 2. 创建一个代表标签背景的矩形 ---
    const backgroundRect = new Konva.Rect({
      x: 0,
      y: 0,
      width: stageWidth,
      height: stageHeight,
      fill: '#FFFFFF', // 标签底色
      stroke: '#dddddd', // 边框颜色
      strokeWidth: 1
    });
    layer.add(backgroundRect);

    // --- 3. 创建核心的文本对象 ---
    const konvaText = new Konva.Text({
      x: stageWidth / 2,
      y: stageHeight / 2,
      text: '你的文字',
      fontSize: 20,
      fontFamily: 'Arial',
      fill: '#000000',
      draggable: true, // 让文字可以被拖动
    });
    // 让文本居中
    konvaText.offsetX(konvaText.width() / 2);
    konvaText.offsetY(konvaText.height() / 2);
    layer.add(konvaText);
    
    layer.draw(); // 首次绘制

    // --- 4. 关联 HTML 控件和 Konva 文本对象 ---
    const textInput = document.getElementById('text-input');
    const fontSizeInput = document.getElementById('font-size-input');
    const colorInput = document.getElementById('color-input');

    // 监听文本输入
    textInput.addEventListener('input', (e) => {
      konvaText.text(e.target.value);
      konvaText.offsetX(konvaText.width() / 2); // 保持居中
      layer.draw();
    });

    // 监听字体大小变化
    fontSizeInput.addEventListener('input', (e) => {
      konvaText.fontSize(parseInt(e.target.value, 10));
      konvaText.offsetX(konvaText.width() / 2); // 保持居中
      konvaText.offsetY(konvaText.height() / 2);
      layer.draw();
    });

    // 监听颜色变化
    colorInput.addEventListener('input', (e) => {
      konvaText.fill(e.target.value);
      layer.draw();
    });
    
    // --- 5. 添加到购物车逻辑 ---
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    addToCartBtn.addEventListener('click', function(e) {
      e.preventDefault();

      // 获取当前产品页面的变体ID
      const variantId = document.querySelector('input[name="id"]').value;
      if (!variantId) {
        alert('请先选择一个产品规格！');
        return;
      }
      
      // 生成预览图 (Base64格式)
      // 我们暂时将背景矩形隐藏，只导出文本的图像
      backgroundRect.hide();
      layer.draw();
      const previewImage = stage.toDataURL({ pixelRatio: 2 }); // pixelRatio 提高清晰度
      backgroundRect.show(); // 恢复显示
      layer.draw();

      // 准备要发送到购物车的数据
      let formData = {
        'items': [{
          'id': variantId,
          'quantity': 1, // 暂时硬编码为1，你可以添加一个数量输入框
          'properties': {
            '_CustomTextPreview': previewImage,
            '定制文字': textInput.value,
            '字体大小': fontSizeInput.value,
            '字体颜色': colorInput.value
          }
        }]
      };

      // 使用 Shopify Ajax API 添加到购物车
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status) {
            alert('添加失败: ' + data.description);
        } else {
            // 添加成功后，跳转到购物车页面
            window.location.href = '/cart';
        }
      })
      .catch((error) => {
        console.error('Error:', error);
        alert('添加时发生错误，请查看控制台。');
      });
    });
  });
</script>

{% schema %}
{
  "name": "Product Text Customizer",
  "settings": [],
  "presets": [
    {
      "name": "Product Text Customizer"
    }
  ]
}
{% endschema %}