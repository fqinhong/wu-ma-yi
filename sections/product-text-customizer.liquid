<script>
  // 使用一个更可靠的方式确保DOM加载完毕
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCustomizer);
  } else {
      initCustomizer();
  }

  function initCustomizer() {
    console.log("步骤 1: initCustomizer 函数开始执行。");

    const container = document.querySelector('#konva-container');
    if (!container) {
      console.error("错误: 找不到ID为 'konva-container' 的元素！请检查HTML结构。");
      return; // 找不到容器，直接退出
    }
    console.log("步骤 2: 成功找到 #konva-container 元素:", container);
    
    // 确保容器有尺寸
    if (container.clientWidth === 0 || container.clientHeight === 0) {
      console.error("错误: #konva-container 的宽度或高度为0！请检查CSS。");
      // 即使尺寸为0，我们仍然尝试创建，但会给出警告
    }

    const stageWidth = container.clientWidth;
    const stageHeight = container.clientHeight;
    console.log(`步骤 3: 准备创建舞台，尺寸: ${stageWidth} x ${stageHeight}`);

    // --- 初始化 Konva 画布 ---
    const stage = new Konva.Stage({
      container: 'konva-container',
      width: stageWidth,
      height: stageHeight,
    });

    const layer = new Konva.Layer();
    stage.add(layer);
    console.log("步骤 4: Konva 舞台 (Stage) 和图层 (Layer) 创建成功。");

    // --- 创建背景矩形 ---
    const backgroundRect = new Konva.Rect({
      x: 0, y: 0, width: stageWidth, height: stageHeight,
      fill: '#FFFFFF', stroke: '#dddddd', strokeWidth: 1
    });
    layer.add(backgroundRect);

    // --- 创建核心的文本对象 ---
    const konvaText = new Konva.Text({
      x: stageWidth / 2,
      y: stageHeight / 2,
      text: '你的文字', // 确保有默认文字
      fontSize: 20,
      fontFamily: 'Arial',
      fill: '#000000', // 确保颜色和背景色不同
      draggable: true,
    });
    
    // 必须在添加到图层后才能准确计算偏移
    layer.add(konvaText);
    
    // 将文本的中心点移动到其坐标(x,y)处
    konvaText.offsetX(konvaText.width() / 2);
    konvaText.offsetY(konvaText.height() / 2);
    
    console.log("步骤 5: Konva 文本对象创建并已添加到图层。");

    // --- 首次绘制 ---
    layer.draw();
    console.log("步骤 6: 执行 layer.draw()，画布应该已更新。");

    // --- 关联 HTML 控件和 Konva 文本对象 ---
    const textInput = document.getElementById('text-input');
    const fontSizeInput = document.getElementById('font-size-input');
    const colorInput = document.getElementById('color-input');

    textInput.addEventListener('input', (e) => {
      konvaText.text(e.target.value);
      konvaText.offsetX(konvaText.width() / 2); // 每次文本改变都重新计算中心点
      layer.draw();
    });

    fontSizeInput.addEventListener('input', (e) => {
      konvaText.fontSize(parseInt(e.target.value, 10));
      konvaText.offsetX(konvaText.width() / 2);
      konvaText.offsetY(konvaText.height() / 2);
      layer.draw();
    });

    colorInput.addEventListener('input', (e) => {
      konvaText.fill(e.target.value);
      layer.draw();
    });
    console.log("步骤 7: 所有事件监听器已添加。");

    // --- 添加到购物车逻辑 ---
    // (这部分代码保持不变)
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    addToCartBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const variantId = document.querySelector('input[name="id"]')?.value || document.querySelector('[name="id"]')?.value;
      if (!variantId) {
        alert('请先选择一个产品规格！');
        return;
      }
      backgroundRect.hide();
      layer.draw();
      const previewImage = stage.toDataURL({ pixelRatio: 2 });
      backgroundRect.show();
      layer.draw();
      let formData = {
        'items': [{
          'id': variantId,
          'quantity': 1,
          'properties': {
            '_CustomTextPreview': previewImage,
            '定制文字': textInput.value,
            '字体大小': fontSizeInput.value,
            '字体颜色': colorInput.value
          }
        }]
      };
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status) {
            alert('添加失败: ' + data.description);
        } else {
            window.location.href = '/cart';
        }
      })
      .catch((error) => {
        console.error('添加到购物车时发生错误:', error);
      });
    });
  }
</script>